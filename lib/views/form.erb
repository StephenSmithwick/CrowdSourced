<div class="menu-left">
	<form action="/processTweets" method="post">
		<div class="label">Suburb</div>
		<div class="value">
			<select id="select-suburb" name="suburbId">
			  	<% @suburbs.each do |suburb| %>
			      <option value="<%= "#{suburb["id"]}" %>"><%= "#{suburb["name"]}" %></option>
				<% end %>
			</select>
		</div>
		<div class="clear"></div>
		
		<div class="label">Cafe</div>
		<div class="value">
			  <select id="select-cafe" name="cafeId">
			  	<% @cafes.each do |cafe| %>
			      <option value="<%= "#{cafe["_id"]}" %>"><%= "#{cafe["name"]}" %></option>
				<% end %>
			  </select>
		</div>
		<div class="clear"></div>
	</form>
</div>

<div id="map-canvas" class="map"></div>

<div id="reviews">
	<div class="reviews-header">
		<span id="review-header-text"></span>
		<a class="review-close" href="#" onclick="$('#reviews').hide();"><img src="/images/close.png" /></a>
	</div>
	<div class="clear"></div>
	<div id="reviews-content"></div>
</div>

<div class="clear"></div>

<script>
	$(document).ready(function() {
		$('#reviews').hide();
		$("#select-suburb").bind("change", function(event, ui) {
	          loadSuburb();
	    });
	    
	    $('#map-canvas').gmap({'disableDefaultUI':true}).bind('init', function(event, map) { 
			loadSuburb();
			$('#map-canvas').gmap('addControl', 'reviews', google.maps.ControlPosition.TOP_LEFT);
		});
	});

	function loadSuburb() {
        $.getJSON("/places/" + $("#select-suburb option:selected").val() + "/cafe", function(data){
		     	$('#map-canvas').gmap('clear', 'markers');
		     	$('#map-canvas').gmap('closeInfoWindow');
		     	var html = '';
			    var len = data.length;
			    for (var i = 0; i< len; i++) {
			        html += '<option value="' + data[i].id + '">' + data[i].name + '</option>';
					$('#map-canvas').gmap('addMarker', {
							'position':  new google.maps.LatLng(data[i].lat, data[i].lon),
							'bounds': true,
							'icon': 'images/markers/cafe.png',
							'place': data[i]}).click(function() {
								$("#reviews").hide();
								var infoContent = this.place.name + ' (' + (this.place.rating * 20) + '%)<br/>';
								infoContent += '<a onclick="loadReviews(\'' + this.place.id + '\', \'' + this.place.name + '\');" href="#">Reviews</a>';
								$('#map-canvas').gmap('openInfoWindow', { 'content': infoContent }, this);
							});
			    }
			    $("#select-cafe").html(html);
		});
		
		$.getJSON("/suburb/" + $("#select-suburb option:selected").val(), function(suburb){
			var suburbGeoCode = new google.maps.LatLng(-suburb.lat, suburb.lon);
			$('#map-canvas').gmap('option', 'center', suburbGeoCode);
			$('#map-canvas').gmap('option', 'zoom', 15);
		});
	}
	
	function loadReviews(placeId, placeName) {
        $.getJSON("/place/reviews/" + placeId, function(data) {
		     	var html = '';
			    var len = data.length;
			    if (len > 0) {
				    for (var i = 0; i< len; i++) {
				    	var imgSrc = '/images/';
				    	if (data[i].liked) {
				    		imgSrc += 'thumbs_up_green.gif';
				    	} else {
				    		imgSrc += 'thumbs_down_red.gif';
				    	}
				    	html += '<img src="' + imgSrc + '" />' ;
				        html += data[i].text + '<br/>';
				    }
			   } else {
			   		html += '<br/>No reviews available yet<br/>';
			   }
			   
			   html += '<br/><a href="#" onclick="refreshReviews(\'' + placeId + '\', \'' + placeName + '\');"><img src="/images/refresh.png" /></a>';
			   
			   $("#review-header-text").html('Reviews for ' + placeName);
			   $("#reviews-content").html(html);
		});
		$("#reviews").show();
	}
	
	function refreshReviews(placeId) {
        $.get("/processTweets/" + placeId, function(data) {
        	loadReviews(placeId);
		});
	}
</script>
